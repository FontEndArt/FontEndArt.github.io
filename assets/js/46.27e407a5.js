(window.webpackJsonp=window.webpackJsonp||[]).push([[46],{255:function(e,t,a){"use strict";a.r(t);var n=a(0),s=Object(n.a)({},(function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[a("h1",{attrs:{id:"vue主线剧情之vm-update"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#vue主线剧情之vm-update"}},[e._v("#")]),e._v(" Vue主线剧情之vm._update")]),e._v(" "),a("h2",{attrs:{id:"前言"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#前言"}},[e._v("#")]),e._v(" 前言")]),e._v(" "),a("h2",{attrs:{id:"update源码"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#update源码"}},[e._v("#")]),e._v(" _update源码")]),e._v(" "),a("p",[a("a",{attrs:{href:"https://github.com/vuejs/vue/blob/dev/src/core/instance/lifecycle.js#L59-L88",target:"_blank",rel:"noopener noreferrer"}},[e._v("vm._update"),a("OutboundLink")],1)]),e._v(" "),a("p",[e._v("我们都知道"),a("code",[e._v("vm._update")]),e._v("是负责渲染vnode的，通过源码的大概阅读可以知道，"),a("code",[e._v("vm._update")]),e._v(" 的核心就是 "),a("code",[e._v("vm.__patch__")]),e._v("，通过 "),a("code",[e._v("vm.__patch__")]),e._v(" 函数来实现将 vnode 转换成真实的 node 节点。")]),e._v(" "),a("p",[e._v("由于我们这里只关心web的相关实现，我们在web的runtime入口处看到有这么一行代码：")]),e._v(" "),a("div",{staticClass:"language-javascript line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// install platform patch function")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("Vue")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("prototype"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("__patch__ "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" inBrowser "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("?")]),e._v(" patch "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" noop\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br")])]),a("p",[e._v("所以我们顺着环境来寻找patch。")]),e._v(" "),a("h2",{attrs:{id:"patch"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#patch"}},[e._v("#")]),e._v(" patch")]),e._v(" "),a("p",[a("a",{attrs:{href:"https://github.com/vuejs/vue/blob/f64765fa03c1eb1d37f3301ea5beb4d18e57158a/src/platforms/web/runtime/patch.js#L3-L12",target:"_blank",rel:"noopener noreferrer"}},[e._v("vue/src/platforms/web/runtime/patch.js"),a("OutboundLink")],1),e._v(" 我们先来这里看一眼有什么东西。")]),e._v(" "),a("p",[e._v("patch实质是调用了 "),a("code",[e._v("createPatchFunction")]),e._v(" 方法的返回值")]),e._v(" "),a("h2",{attrs:{id:"createpatchfunction"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#createpatchfunction"}},[e._v("#")]),e._v(" createPatchFunction")]),e._v(" "),a("div",{staticClass:"language-javascript line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("export")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("function")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("createPatchFunction")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[e._v("backend")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br")])]),a("p",[a("a",{attrs:{href:"https://github.com/vuejs/vue/blob/f64765fa03c1eb1d37f3301ea5beb4d18e57158a/src/core/vdom/patch.js#L700-L803",target:"_blank",rel:"noopener noreferrer"}},[e._v("createPatchFunction return function path(){}"),a("OutboundLink")],1)]),e._v(" "),a("div",{staticClass:"language-javascript line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br")])]),a("p",[e._v("返回的 path 函数 本身接收4个参数， 分别是：")]),e._v(" "),a("ul",[a("li",[e._v("oldVnode 顾名思义，表示旧的 VNode 节点（看代码也看到了，oldVnode也可以是一个真实的dom对象）")]),e._v(" "),a("li",[e._v("vnode 表示执行 _render 后返回的 VNode 的节点")]),e._v(" "),a("li",[e._v("hydrating 依旧忽略先（虽然大家可能看其他文章看到这个东西是做什么用的）")]),e._v(" "),a("li",[e._v("removeOnly 是给 patchVnode 用的，暂时不管")])]),e._v(" "),a("p",[e._v("看看 path 方法主要用了哪些方法，做了什么事情。")]),e._v(" "),a("p",[e._v("主要调用了以下三个方法：")]),e._v(" "),a("ul",[a("li",[e._v("createElm\n"),a("ul",[a("li",[e._v("createElm(vnode, insertedVnodeQueue)")]),e._v(" "),a("li",[e._v("分析这个调用的大概意思就是，通过当前的vnode节点，加入到Vnode的队列中，创建元素（可能会插入到Dom节点中）")])])]),e._v(" "),a("li",[e._v("sameVnode\n"),a("ul",[a("li",[e._v("sameVnode(oldVnode, vnode)")]),e._v(" "),a("li",[e._v("语义化很明显啊，就是比较oldVnode和vnode。（比较就是看看两个节点是否一致，是不是同一个节点）")])])]),e._v(" "),a("li",[e._v("patchVnode\n"),a("ul",[a("li",[e._v("patchVnode(oldVnode, vnode, insertedVnodeQueue, null, null, removeOnly)")]),e._v(" "),a("li",[a("a",{attrs:{href:"https://github.com/vuejs/vue/blob/f64765fa03c1eb1d37f3301ea5beb4d18e57158a/src/core/vdom/patch.js#L501-L574",target:"_blank",rel:"noopener noreferrer"}},[e._v("源码地址"),a("OutboundLink")],1)]),e._v(" "),a("li",[e._v("这个方法是整个vdom体系中的核心，用来更新dom。（回头会单开一个副本来刷）")])])])]),e._v(" "),a("h2",{attrs:{id:"总结"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[e._v("#")]),e._v(" 总结")]),e._v(" "),a("p",[e._v("整体来说，_update就是利用createPatchFunction返回的path方法来进行创建、比较、更新生成真实节点。")]),e._v(" "),a("p",[e._v("至于具体是怎么增加、删除、更新vnode和dom节点，我会开一个副本的。毕竟dom-diff比较复杂。")]),e._v(" "),a("p",[e._v("至此，Vue的主线任务完成了。\n最后，我们用一张图来总结一下整个流程。")]),e._v(" "),a("p",[a("img",{attrs:{src:"https://tva1.sinaimg.cn/large/006y8mN6ly1g9a3jdsmzfj31qc0mnt9m.jpg",alt:""}})])])}),[],!1,null,null,null);t.default=s.exports}}]);